<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="ulearn">
  <head>
    <div metal:fill-slot="javascript_head_slot" tal:omit-tag="">
      <style>
        .dt-center {
          text-align: center !important;
        }
        .invisible-header {
          display: none;
        }
      </style>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
      <script type="text/javascript" src="https://cdn.datatables.net/r/bs-3.3.5/jqc-1.11.3,dt-1.10.8/datatables.min.js"></script>
      <script type="text/javascript" tal:define="sections view/sections; dataset view/getDataset; accessedIndex view/accessedIndex; separator view/getSeparator" tal:content="python:str('var sections=' + str(sections) + ',dataset=' + dataset + ',accessed_index=' + str(accessedIndex) + ',separator=' + separator + ';')" />
      <script type="text/javascript">
        $.fn.dataTable.ext.order['customOrder'] = function(settings, col){
          return this.api().column(col, {order: 'index'}).nodes().map(function(td, i){
            var res = td.innerHTML.split(separator);
            return parseInt(res[res.length - 1]);
          });
        };
        $(document).ready(function(){
          for (var i = 0; i < sections.length; i++) {
            $('#' + sections[i] + '_checkbox').change(function(event){
              var index = parseInt(event.target.getAttribute("data-section-index"));
              $('#' + event.target.getAttribute("data-section-name") + '_table')
                .DataTable()
                .clear()
                .rows.add(dataset[sections[index]]
                                 [event.target.checked?1:0])
                .draw();
            });
            $('#' + sections[i] + '_table').DataTable({
              "data": dataset[sections[i]]
                             [$('#' + sections[i] + '_checkbox')[0].checked?1:0],
              "columnDefs": [{className: "dt-center",
                              orderDataType: "customOrder",
                              type: "num",
                              "targets": "dt-center"}]
            });
          }
          setTimeout(function(){
            $.ajax("stats_overview?update").done(
              function(data){
                dataset = JSON.parse(data);
                $('#' + sections[accessed_index] + '_table')
                  .DataTable()
                  .clear()
                  .rows.add(
                    dataset[sections[accessed_index]]
                           [$('#' + sections[accessed_index] + '_checkbox')[0].checked?1:0]
                  )
                  .draw();
                $('#' + sections[accessed_index] + '_updating').toggleClass("invisible-header");
              }
            );
            $('#' + sections[accessed_index] + '_updating').toggleClass("invisible-header");
          }, 1000);
        });
      </script>
    </div>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border', 1)" />
  </head>
  <body>
    <metal:main fill-slot="main">
      <metal:content-core define-macro="main">
        <div id="viewlet-above-content-title"></div>
        <h1 class="documentFirstHeading">General overview</h1>
        <div style="margin-bottom: 50px;"
             tal:define="datePoints view/datePoints;
                         sections view/sections"
             tal:repeat="name sections">
          <div id="viewlet-above-content-title"></div>
          <h2 class="documentFirstHeading">
            <span tal:content="string:${name} documents over time" />
            <span class="invisible-header" tal:attributes="id string:${name}_updating">[Updating...]</span>
            <span style="float: right;">
                <label tal:attributes="for string:${name}_checkbox">Accumulative results</label>
                <input type="checkbox" tal:attributes="id string:${name}_checkbox; data-section-name string:${name}; data-section-index repeat/name/index" style="margin-top: 2px;">
            </span>
          </h2>
          <table tal:attributes="id string:${name}_table" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Community name</th>
                <th class="dt-center" tal:repeat="datePoint datePoints" tal:content="datePoint"/>
              </tr>
            </thead>
          </table>
        </div>
      </metal:content-core>
    </metal:main>
  </body>
</html>